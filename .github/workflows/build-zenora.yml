name: Build ARM64 rootfs for Termux

on:
  workflow_dispatch:
  schedule:
    - cron: '24 7 1 * *'

jobs:
  build-rootfs:
    runs-on: ubuntu-latest
    name: "Build ARM64 rootfs"
    container: 
      image: archlinux/archlinux
      options: --privileged

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare container environment
        run: |
          pacman-key --init
          pacman-key --populate
          echo -e "\n[zrepo]\nSigLevel = Never\nServer = https://codeberg.org/zenoralinux/zenora-repo/media/branch/main/\$arch" >> /etc/pacman.conf
          pacman -Sy --noconfirm archlinux-keyring
          pacman -Syu --noconfirm
          pacman -S --noconfirm arch-install-scripts wget curl base-devel zip unzip zsh shadow qemu qemu-user-static binfmt-support

      - name: Set image version and prepare rootfs
        run: |
          echo "IMAGE_VERSION=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          mkdir /mnt/sys-root-skeleton /mnt/sys-root
          mount --bind /mnt/sys-root-skeleton /mnt/sys-root
          wget -O target-pacman.conf https://raw.githubusercontent.com/zenoralinux/wsl-zenora-rootfs/refs/heads/main/pacman.conf
          # Enable ARM architecture support
          echo -e "\n[archlinuxarm]\nSigLevel = Never\nServer = http://mirror.archlinuxarm.org/\$arch/\$repo" >> /etc/pacman.conf

      - name: Initialize rootfs base system for ARM64
        run: |
          # Register ARM binaries to run via qemu
          update-binfmts --enable qemu-aarch64
          # Create base system for aarch64
          pacstrap -C target-pacman.conf -K /mnt/sys-root --arch aarch64 base curl wget vim nano sudo texinfo man-db man-pages zsh shadow

      - name: Configure rootfs
        run: |
          # Configure ARM64 specific settings
          echo "arch = aarch64" >> /mnt/sys-root/etc/pacman.conf
          sed -i 's/^#Server/Server/' /mnt/sys-root/etc/pacman.d/mirrorlist
          sed -i 's/^#Color/Color/; s/^#ParallelDownloads/ParallelDownloads/' /mnt/sys-root/etc/pacman.conf
          echo -e "\n[archlinuxcn]\nSigLevel = Never\nServer = https://repo.archlinuxcn.org/\$arch" >> /mnt/sys-root/etc/pacman.conf
          echo -e "\n[blackarch]\nSigLevel = Never\nServer = https://blackarch.org/blackarch/\$repo/os/\$arch" >> /mnt/sys-root/etc/pacman.conf
          echo -e "\n[archlinuxarm]\nSigLevel = Never\nServer = http://mirror.archlinuxarm.org/\$arch/\$repo" >> /mnt/sys-root/etc/pacman.conf

          # Move zrepo to the top
          awk '/^\[zrepo\]/,/^$/' /mnt/sys-root/etc/pacman.conf > zrepo.conf
          grep -v "^\[zrepo\]" /mnt/sys-root/etc/pacman.conf | grep -v "https://codeberg.org/zenoralinux" > temp.conf
          cat zrepo.conf temp.conf > /mnt/sys-root/etc/pacman.conf
          rm zrepo.conf temp.conf

          echo "%wheel ALL=(ALL:ALL) ALL" > /mnt/sys-root/etc/sudoers.d/wheel
          echo "tmpfs /tmp tmpfs mode=1777,strictatime,nosuid,nodev,size=50%,nr_inodes=1m 0 0" >> /mnt/sys-root/etc/fstab
          echo "PACMAN_IGNORE_LANDLOCK=1" >> /mnt/sys-root/etc/environment

          # Configure locales for ARM64
          echo "en_US.UTF-8 UTF-8" >> /mnt/sys-root/etc/locale.gen
          chroot /mnt/sys-root /usr/bin/locale-gen
          chroot /mnt/sys-root /usr/bin/systemctl mask systemd-binfmt.service systemd-resolved.service systemd-networkd.service tmp.mount
          rm -rf /mnt/sys-root/etc/pacman.d/gnupg /mnt/sys-root/var/lib/pacman/sync/
          rm -f /mnt/sys-root/etc/machine-id
          touch /mnt/sys-root/etc/machine-id
          rm -rf /mnt/sys-root/var/cache/pacman/pkg/*

      - name: Create default user and configure zsh
        run: |
          chroot /mnt/sys-root /usr/bin/useradd -m -G wheel -s /bin/zsh zenora
          echo 'zenora:zenora' | chroot /mnt/sys-root /usr/bin/chpasswd

          # set zsh globally
          echo "/bin/zsh" >> /mnt/sys-root/etc/shells
          echo "SHELL=/bin/zsh" >> /mnt/sys-root/etc/environment
          sed -i 's|^SHELL=.*|SHELL=/bin/zsh|' /mnt/sys-root/etc/default/useradd

          # make zsh default for root
          sed -i 's|^root:.*:bash|root:*:*:/bin/zsh|' /mnt/sys-root/etc/passwd
          cp /mnt/sys-root/etc/skel/.bashrc /mnt/sys-root/etc/skel/.zshrc 2>/dev/null || true
          touch /mnt/sys-root/etc/skel/.zshrc
          touch /mnt/sys-root/home/zenora/.zshrc
          chown 1000:1000 /mnt/sys-root/home/zenora/.zshrc

      - name: Install Zenora packages for ARM64
        run: |
          cp /etc/pacman.conf /mnt/sys-root/etc/pacman.conf
          cp -r /etc/pacman.d /mnt/sys-root/etc/
          chroot /mnt/sys-root /usr/bin/pacman -Sy --noconfirm
          chroot /mnt/sys-root /usr/bin/pacman -S --noconfirm \
            zenora-release \
            zenora-fake-apt \
            zenora-back \
            zenora-wsl-zsh-config \
            zenora-conf-update \
            neofetch \
            zsh \
            glibc

      - name: Cleanup and package rootfs
        run: |
          # Remove unnecessary files for Termux
          rm -rf /mnt/sys-root/usr/lib/wsl
          # Create compressed rootfs
          tar --numeric-owner -czf zenora-arm64-rootfs.tar.gz -C /mnt/sys-root ./

      - name: Generate sha256sums
        run: |
          sha256sum zenora-arm64-rootfs.tar.gz > sha256sums

      - name: Upload artifact
        uses: softprops/action-gh-release@v0.1.15
        with:
          tag_name: "${{ env.IMAGE_VERSION }}"
          files: |
            zenora-arm64-rootfs.tar.gz
            sha256sums
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
