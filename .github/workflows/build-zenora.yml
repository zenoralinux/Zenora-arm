name: Build ARM64 Rootfs (QEMU Emulation)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build-arm64-rootfs:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:latest
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup QEMU environment
        run: |
          # Initialize pacman and install dependencies
          pacman -Sy --noconfirm --needed \
            qemu-full \
            qemu-user-static \
            arch-install-scripts \
            git \
            wget \
            curl \
            haveged

          # Start entropy generation for GPG
          systemctl start haveged

          # Mount binfmt_misc manually
          mount binfmt_misc -t binfmt_misc /proc/sys/fs/binfmt_misc || true
          
          # Register ARM64 emulation
          if [ -f /proc/sys/fs/binfmt_misc/register ]; then
            echo ':aarch64:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xb7\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-aarch64-static:F' > /proc/sys/fs/binfmt_misc/register
          fi

      - name: Prepare rootfs structure
        run: |
          mkdir -p /arm64-rootfs
          
          # Create minimal pacman.conf for ARM64 with specific mirrors
          cat > /tmp/pacman-arm64.conf <<EOF
          [options]
          Architecture = aarch64
          ParallelDownloads = 5
          Color
          SigLevel = Never
          
          [core]
          Server = http://mirror.archlinuxarm.org/\$arch/\$repo
          
          [extra]
          Server = http://mirror.archlinuxarm.org/\$arch/\$repo
          
          [community]
          Server = http://mirror.archlinuxarm.org/\$arch/\$repo
          
          [alarm]
          Server = http://mirror.archlinuxarm.org/\$arch/\$repo
          EOF

      - name: Initialize keyring
        run: |
          # Initialize pacman keyring in target root
          mkdir -p /arm64-rootfs/etc/pacman.d/gnupg
          chmod 700 /arm64-rootfs/etc/pacman.d/gnupg
          pacman-key --init --gpgdir /arm64-rootfs/etc/pacman.d/gnupg
          pacman-key --populate archlinuxarm --gpgdir /arm64-rootfs/etc/pacman.d/gnupg

      - name: Install base system
        run: |
          # First sync package databases using the ARM64 mirror
          pacman -Syy --config /tmp/pacman-arm64.conf
          
          # Install base system with ARM64 emulation
          pacstrap -C /tmp/pacman-arm64.conf -G -M -K /arm64-rootfs \
            base \
            base-devel \
            sudo \
            curl \
            wget \
            vim \
            zsh \
            openssh \
            git \
            man-db \
            man-pages \
            texinfo \
            --needed
          
          # Copy QEMU static binary
          cp /usr/bin/qemu-aarch64-static /arm64-rootfs/usr/bin/

      - name: Configure system
        run: |
          # Basic configuration
          echo "LANG=en_US.UTF-8" > /arm64-rootfs/etc/locale.conf
          echo "en_US.UTF-8 UTF-8" >> /arm64-rootfs/etc/locale.gen
          chroot /arm64-rootfs /usr/bin/locale-gen
          
          ln -sf /usr/share/zoneinfo/UTC /arm64-rootfs/etc/localtime
          
          # User setup
          echo 'root:password' | chroot /arm64-rootfs /usr/bin/chpasswd
          chroot /arm64-rootfs /usr/bin/useradd -m -G wheel -s /bin/zsh alarm
          echo 'alarm:alarm' | chroot /arm64-rootfs /usr/bin/chpasswd
          echo '%wheel ALL=(ALL) ALL' > /arm64-rootfs/etc/sudoers.d/wheel
          
          # Network
          echo "127.0.1.1 alarm.localdomain alarm" >> /arm64-rootfs/etc/hosts
          
          # Configure pacman in target
          echo "Server = http://mirror.archlinuxarm.org/\$arch/\$repo" > /arm64-rootfs/etc/pacman.d/mirrorlist
          sed -i 's/^SigLevel.*/SigLevel = Never/' /arm64-rootfs/etc/pacman.conf

      - name: Cleanup system
        run: |
          # Reduce image size
          rm -f /arm64-rootfs/etc/machine-id
          touch /arm64-rootfs/etc/machine-id
          rm -rf /arm64-rootfs/var/cache/pacman/pkg/*
          rm -rf /arm64-rootfs/var/lib/pacman/sync/*
          rm -rf /arm64-rootfs/etc/pacman.d/gnupg/*

      - name: Create artifact
        run: |
          tar --numeric-owner -czf arm64-rootfs-$(date +%Y%m%d).tar.gz -C /arm64-rootfs .
          sha256sum arm64-rootfs-*.tar.gz > checksum.txt
          du -sh arm64-rootfs-*.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: arm64-rootfs
          path: |
            arm64-rootfs-*.tar.gz
            checksum.txt
          retention-days: 7
