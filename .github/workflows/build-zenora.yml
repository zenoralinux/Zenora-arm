name: Build ARM RootFS

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # اجرای هفتگی

jobs:
  build-rootfs:
    strategy:
      matrix:
        arch: [armv7l, aarch64]
    runs-on: [self-hosted, ARM]
    name: "Build ${{ matrix.arch }} rootfs"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo pacman -Syu --noconfirm --needed \
            arch-install-scripts \
            wget \
            curl \
            git \
            sudo \
            fakeroot \
            archlinux-keyring

      - name: Create rootfs directory
        run: |
          ROOTFS_DIR="/rootfs-${{ matrix.arch }}"
          sudo mkdir -p "${ROOTFS_DIR}"
          sudo chown runner:runner "${ROOTFS_DIR}"

      - name: Configure pacman for Arch Linux ARM
        run: |
          case "${{ matrix.arch }}" in
            armv7l)
              MIRROR="http://mirror.archlinuxarm.org/armv7h/$(uname -m)"
              ;;
            aarch64)
              MIRROR="http://mirror.archlinuxarm.org/aarch64/$(uname -m)"
              ;;
          esac
          
          echo -e "[archlinuxarm]\nSigLevel = Never\nServer = ${MIRROR}" | sudo tee -a /etc/pacman.conf
          sudo pacman -Sy --noconfirm archlinuxarm-keyring

      - name: Bootstrap base system
        run: |
          ROOTFS_DIR="/rootfs-${{ matrix.arch }}"
          
          sudo pacstrap -C /etc/pacman.conf -G -M -K \
            "${ROOTFS_DIR}" \
            base \
            archlinuxarm-keyring \
            base-devel \
            sudo \
            curl \
            wget \
            git \
            vim \
            nano

      - name: Basic system configuration
        run: |
          ROOTFS_DIR="/rootfs-${{ matrix.arch }}"
          
          # تنظیمات پایه
          echo "Server = http://mirror.archlinuxarm.org/\$arch/\$repo" | sudo tee "${ROOTFS_DIR}/etc/pacman.d/mirrorlist"
          echo "LANG=en_US.UTF-8" | sudo tee "${ROOTFS_DIR}/etc/locale.conf"
          echo "en_US.UTF-8 UTF-8" | sudo tee -a "${ROOTFS_DIR}/etc/locale.gen"
          
          # تنظیمات داخل chroot
          sudo arch-chroot "${ROOTFS_DIR}" /bin/bash -c "
            locale-gen
            ln -sf /usr/share/zoneinfo/UTC /etc/localtime
            echo 'root:root' | chpasswd
          "

      - name: Create user and configure sudo
        run: |
          ROOTFS_DIR="/rootfs-${{ matrix.arch }}"
          
          sudo arch-chroot "${ROOTFS_DIR}" /bin/bash -c "
            useradd -m -G wheel -s /bin/bash user
            echo 'user:user' | chpasswd
            echo '%wheel ALL=(ALL:ALL) ALL' > /etc/sudoers.d/wheel
            chmod 440 /etc/sudoers.d/wheel
          "

      - name: Cleanup rootfs
        run: |
          ROOTFS_DIR="/rootfs-${{ matrix.arch }}"
          
          sudo rm -rf "${ROOTFS_DIR}/var/cache/pacman/pkg"/*
          sudo rm -f "${ROOTFS_DIR}/etc/machine-id"
          sudo touch "${ROOTFS_DIR}/etc/machine-id"
          sudo rm -rf "${ROOTFS_DIR}/var/log"/*
          sudo find "${ROOTFS_DIR}/usr/share/man" -type f -delete

      - name: Package rootfs
        run: |
          ROOTFS_DIR="/rootfs-${{ matrix.arch }}"
          OUTPUT_FILE="archlinux-${{ matrix.arch }}-rootfs-$(date +%Y%m%d).tar.gz"
          
          sudo tar --numeric-owner --xattrs --acls -czf "${OUTPUT_FILE}" -C "${ROOTFS_DIR}" .
          sha256sum "${OUTPUT_FILE}" > "${OUTPUT_FILE}.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: archlinux-${{ matrix.arch }}-rootfs
          path: |
            archlinux-${{ matrix.arch }}-rootfs-*.tar.gz
            archlinux-${{ matrix.arch }}-rootfs-*.sha256

      - name: Create GitHub release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: arm-rootfs-${{ github.run_id }}
          files: |
            archlinux-armv7l-rootfs-*.tar.gz
            archlinux-armv7l-rootfs-*.sha256
            archlinux-aarch64-rootfs-*.tar.gz
            archlinux-aarch64-rootfs-*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
