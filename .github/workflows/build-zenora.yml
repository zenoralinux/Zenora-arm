name: Build ARM RootFS with Docker

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  build-rootfs:
    strategy:
      matrix:
        arch: [arm32v7, arm64v8]
    runs-on: ubuntu-latest
    name: "Build ${{ matrix.arch }} rootfs with Docker"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build minimal rootfs
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/${{ matrix.arch }}
          outputs: type=local,dest=./rootfs
          tags: rootfs-builder
          build-args: |
            ARCH=${{ matrix.arch }}

      - name: Package rootfs
        run: |
          cd rootfs
          tar -czf "../${{ matrix.arch }}-rootfs.tar.gz" .
          sha256sum "../${{ matrix.arch }}-rootfs.tar.gz" > "../${{ matrix.arch }}-rootfs.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.arch }}-rootfs
          path: |
            ${{ matrix.arch }}-rootfs.tar.gz
            ${{ matrix.arch }}-rootfs.sha256
