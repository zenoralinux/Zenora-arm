name: Build ARM64 Rootfs (QEMU Emulation)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build-arm64-rootfs:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:latest
      options: --device /dev/kvm --security-opt seccomp=unconfined

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup QEMU environment
        run: |
          # Initialize pacman and install dependencies
          pacman-key --init
          pacman-key --populate
          pacman -Sy --noconfirm --needed \
            qemu-full \
            qemu-user-static \
            qemu-user-static-binfmt \
            arch-install-scripts \
            git \
            wget \
            curl \
            docker

          # Enable ARM64 emulation
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          update-binfmts --enable qemu-aarch64
          systemctl restart systemd-binfmt.service

      - name: Prepare rootfs structure
        run: |
          mkdir -p /arm64-rootfs
          wget -O /tmp/pacman-arm64.conf https://raw.githubusercontent.com/archlinuxarm/PKGBUILDs/master/etc/pacman.conf
          
          # Configure pacman for ARM64
          sed -i \
            -e 's/#Architecture = auto/Architecture = aarch64/' \
            -e 's|#Include = /etc/pacman.d/mirrorlist|Include = /etc/pacman.d/mirrorlist|' \
            -e 's/^#ParallelDownloads/ParallelDownloads/' \
            /tmp/pacman-arm64.conf
          
          # Add Arch Linux ARM repositories
          echo -e "\n[alarm]\nSigLevel = Never\nServer = http://mirror.archlinuxarm.org/\$arch/\$repo" >> /tmp/pacman-arm64.conf
          echo -e "\n[archlinuxarm]\nSigLevel = Never\nServer = http://mirror.archlinuxarm.org/\$arch/\$repo" >> /tmp/pacman-arm64.conf

      - name: Install base system
        run: |
          # Install base system with ARM64 emulation
          pacstrap -C /tmp/pacman-arm64.conf -G -M -K /arm64-rootfs \
            base \
            base-devel \
            sudo \
            curl \
            wget \
            vim \
            zsh \
            openssh \
            git \
            man-db \
            man-pages \
            texinfo \
            --arch aarch64
          
          # Copy QEMU static binary for chroot
          cp /usr/bin/qemu-aarch64-static /arm64-rootfs/usr/bin/

      - name: Configure system
        run: |
          # Basic system configuration
          arch-chroot /arm64-rootfs /bin/bash <<'EOF'
          # Locale and time
          echo "LANG=en_US.UTF-8" > /etc/locale.conf
          echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
          locale-gen
          ln -sf /usr/share/zoneinfo/UTC /etc/localtime
          
          # User management
          echo "root:password" | chpasswd
          useradd -m -G wheel -s /bin/zsh alarm
          echo "alarm:alarm" | chpasswd
          echo "%wheel ALL=(ALL) ALL" >> /etc/sudoers
          
          # Network
          echo "127.0.1.1 alarm.localdomain alarm" >> /etc/hosts
          systemctl enable systemd-networkd.service
          systemctl enable systemd-resolved.service
          
          # Pacman configuration
          sed -i 's/^#Color/Color/' /etc/pacman.conf
          sed -i 's/^#ParallelDownloads/ParallelDownloads/' /etc/pacman.conf
          EOF

      - name: Cleanup system
        run: |
          # Clean up to reduce image size
          arch-chroot /arm64-rootfs /bin/bash <<'EOF'
          pacman -Scc --noconfirm
          rm -rf /var/cache/pacman/pkg/*
          rm -rf /var/lib/pacman/sync/*
          rm -f /etc/machine-id
          touch /etc/machine-id
          EOF

      - name: Create artifact
        run: |
          # Create compressed rootfs with proper ownership
          tar --numeric-owner -czf arm64-rootfs-$(date +%Y%m%d).tar.gz -C /arm64-rootfs .
          sha256sum arm64-rootfs-*.tar.gz > checksum.txt
          du -sh arm64-rootfs-*.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: arm64-rootfs
          path: |
            arm64-rootfs-*.tar.gz
            checksum.txt
          retention-days: 7
