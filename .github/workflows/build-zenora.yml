name: Build ARM64 rootfs

on:
  workflow_dispatch:
  schedule:
    - cron: '24 7 1 * *'

jobs:
  build-rootfs:
    runs-on: ubuntu-latest
    name: "Build ARM64 rootfs"
    container: 
      image: archlinux/archlinux
      options: --privileged

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare ARM64 environment
        run: |
          pacman-key --init
          pacman-key --populate
          pacman -Sy --noconfirm archlinux-keyring qemu qemu-arch-extra binfmt-support
          systemctl restart systemd-binfmt.service
          pacman -Syu --noconfirm arch-install-scripts wget curl base-devel

      - name: Set image version and prepare rootfs
        run: |
          echo "IMAGE_VERSION=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          mkdir /mnt/sys-root
          # Download ARM64-specific pacman.conf
          wget -O /target-pacman.conf https://raw.githubusercontent.com/archlinuxarm/PKGBUILDs/master/etc/pacman.conf
          sed -i 's|#Architecture.*|Architecture = aarch64|' /target-pacman.conf

      - name: Initialize ARM64 rootfs
        run: |
          # Use Arch Linux ARM repositories
          echo -e "\n[alarm]\nSigLevel = Never\nServer = http://mirror.archlinuxarm.org/\$arch/\$repo" >> /target-pacman.conf
          # Install base system for ARM64
          pacstrap -C /target-pacman.conf -K /mnt/sys-root base base-devel --arch=aarch64
          cp /usr/bin/qemu-aarch64-static /mnt/sys-root/usr/bin/

      - name: Configure rootfs
        run: |
          arch-chroot /mnt/sys-root /bin/bash <<EOF
          sed -i 's/^#Server/Server/' /etc/pacman.d/mirrorlist
          echo "LANG=en_US.UTF-8" > /etc/locale.conf
          echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
          locale-gen
          EOF

      - name: Install Zenora packages (ARM64)
        run: |
          arch-chroot /mnt/sys-root /bin/bash <<EOF
          pacman -Sy --noconfirm \
            zsh \
            neofetch \
            sudo \
            curl \
            wget
          EOF

      - name: Package rootfs
        run: |
          tar --numeric-owner -czf zenora-arm64-rootfs.tar.gz -C /mnt/sys-root .

      - name: Upload artifact
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: zenora-arm64-rootfs.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
