name: Build ARM64 Rootfs (QEMU Emulation)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # روزانه اجرا شود

jobs:
  build-arm64-rootfs:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:latest
      options: --device /dev/kvm --security-opt seccomp=unconfined  # نیازمندی‌های QEMU

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup QEMU and dependencies
        run: |
          pacman -Sy --noconfirm qemu-full qemu-user-static binfmt-support arch-install-scripts

          # فعال‌سازی پشتیبانی از ARM64
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Prepare ARM64 environment
        run: |
          mkdir -p /arm64-rootfs
          wget -O /tmp/pacman-arm64.conf https://raw.githubusercontent.com/archlinuxarm/PKGBUILDs/master/etc/pacman.conf
          sed -i 's/#Architecture = auto/Architecture = aarch64/' /tmp/pacman-arm64.conf
          echo -e "\n[alarm]\nSigLevel = Never\nServer = http://mirror.archlinuxarm.org/\$arch/\$repo" >> /tmp/pacman-arm64.conf

      - name: Install base system
        run: |
          pacstrap -C /tmp/pacman-arm64.conf -K /arm64-rootfs base base-devel
          cp /usr/bin/qemu-aarch64-static /arm64-rootfs/usr/bin/

      - name: Basic system configuration
        run: |
          arch-chroot /arm64-rootfs /bin/bash <<EOF
          echo "LANG=en_US.UTF-8" > /etc/locale.conf
          echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
          locale-gen
          ln -sf /usr/share/zoneinfo/UTC /etc/localtime
          EOF

      - name: Create and upload artifact
        run: |
          tar --numeric-owner -czf arm64-rootfs-$(date +%Y%m%d).tar.gz -C /arm64-rootfs .
          sha256sum arm64-rootfs-*.tar.gz > checksum.txt

      - name: Upload rootfs
        uses: actions/upload-artifact@v3
        with:
          name: arm64-rootfs
          path: |
            arm64-rootfs-*.tar.gz
            checksum.txt
